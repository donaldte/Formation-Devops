pipeline {
  agent {
    docker {
      image 'donald284/maven-jenkins-agent:v3'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    DOCKER_IMAGE   = "donald284/ultimate-cicd:${BUILD_NUMBER}"
    GIT_REPO_NAME  = "Formation-Devops"
    GIT_USER_NAME  = "donaldte"
  }

  stages {
    stage('1. Build et Tests (Maven)') {
      steps {
        sh '''
          cd Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app
          mvn clean package
        '''
      }
    }

    stage('2. Analyse Statique SonarQube') {
      steps {
        withCredentials([string(credentialsId: 'sonarqube', variable: 'SONAR_AUTH_TOKEN')]) {
          sh """
            cd Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app
            mvn sonar:sonar -Dsonar.login=$SONAR_AUTH_TOKEN -Dsonar.host.url=${env.SONAR_URL}
          """
        }
      }
    }

    stage('3. Build et Push de l’image Docker') {
      steps {
        sh "docker build -t ${DOCKER_IMAGE} Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app/."
        docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
          docker.image("${DOCKER_IMAGE}").push()
          docker.image("${DOCKER_IMAGE}").push('latest')
        }
      }
    }

    // STAGE 4 CORRIGÉ — SANS ACCOLADE EN TROP
    stage('4. Mise à jour du manifeste Kubernetes') {
      agent none
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            set -e
            REPO_DIR="$WORKSPACE/temp-gitops-repo"
            rm -rf "$REPO_DIR"
            mkdir -p "$REPO_DIR"

            git clone https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git "$REPO_DIR"
            cd "$REPO_DIR"

            git config user.email "donaldtedom0@gmail.com"
            git config user.name "donaldte"

            # CETTE LIGNE EST LA BONNE (elle marche quel que soit le tag actuel)
            sed -i "/image:[[:space:]]*donald284\\/ultimate-cicd:/ s/:.*$/:${BUILD_NUMBER}/" \
              Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

            git add Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

            if git diff --staged --quiet; then
              echo "Aucun changement → rien à pousser"
              exit 0
            fi

            git commit -m "Deploy v${BUILD_NUMBER} (build #${BUILD_NUMBER})"
            git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main

            echo "Push réussi ! ArgoCD va déployer la v${BUILD_NUMBER}"
          '''
        }
      }
    }
  }

  post {
    success { slackSend(channel: '#general', color: '#36a64f', message: "SUCCESS — Build #${BUILD_NUMBER} déployé !") }
    failure { slackSend(channel: '#general', color: '#ff0000', message: "FAILURE — Build #${BUILD_NUMBER} échoué") }
  }
}