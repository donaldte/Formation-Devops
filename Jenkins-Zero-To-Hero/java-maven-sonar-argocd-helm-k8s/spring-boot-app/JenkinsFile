pipeline {
    // =============================================
    // OPTIONS OBLIGATOIRES
    // =============================================
    options {
        skipDefaultCheckout(true)
        timeout(time: 30, unit: 'MINUTES')
        timestamps()                   // ← pour voir les logs avec heure
    }

    // =============================================
    // AGENT GLOBAL (Docker) — pour tous les stages SAUF le 4
    // =============================================
    agent {
        docker {
            image 'donald284/maven-jenkins-agent:v3'
            args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
            reuseNode true
        }
    }

    environment {
        DOCKER_IMAGE = "donald284/ultimate-cicd:${BUILD_NUMBER}"
        GIT_REPO_NAME = "Formation-Devops"
        GIT_USER_NAME = "donaldte"
    }

    stages {
        // Stage 0 : Checkout → maintenant il s'exécute vraiment
        stage('0. Checkout') {
            steps {
                git branch: 'main', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
                sh 'pwd && ls -la'
            }
        }

        stage('1. Build et Tests (Maven)') {
            steps {
                sh """
                    cd Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app
                    mvn clean package
                """
            }
        }

        // ... stages 2 et 3 inchangés ...

        // Stage 4 : GitOps → SUR LE MASTER JENKINS (pas dans le container !)
        stage('4. Mise à jour du manifeste Kubernetes') {
            agent none                              // ←←← OBLIGATOIRE
            steps {
                withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        set -e
                        REPO_DIR="$WORKSPACE/temp-gitops"
                        rm -rf "$REPO_DIR"
                        mkdir -p "$REPO_DIR"
                        git clone https://github.com/donaldte/Formation-Devops.git "$REPO_DIR"
                        cd "$REPO_DIR"

                        sed -i "s#image: donald284/ultimate-cicd:.*#image: donald284/ultimate-cicd:${BUILD_NUMBER}#" \
                            Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

                        git add Jenkins-Zero-To-Hero/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml || echo "Rien à ajouter"
                        if git diff --staged --quiet; then
                            echo "Aucun changement dans le manifest → rien à push"
                            exit 0
                        fi

                        git commit -m "Deploy v${BUILD_NUMBER}"
                        git push https://$GITHUB_TOKEN@github.com/donaldte/Formation-Devops.git HEAD:main
                        echo "Manifest mis à jour ! ArgoCD va déployer la version ${BUILD_NUMBER}"
                    '''
                }
            }
        }
    }

    post {
        success { slackSend(channel: '#test-jenkins', color: 'good', message: "SUCCÈS #${BUILD_NUMBER}") }
        failure { slackSend(channel: '#test-jenkins', color: 'danger', message: "ÉCHEC #${BUILD_NUMBER}") }
    }
}